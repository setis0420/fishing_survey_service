# 위판 실적 조회 수정 기능 개발 내역

## 작업일: 2026-03-01

---

## 1. 개요

위판 실적 조회 페이지에서 위판/사매/경비 데이터를 상세 보기하고, 직접 수정할 수 있는 기능을 추가했습니다.

---

## 2. 주요 기능

### 2.1 상세 보기 다이얼로그
- 테이블 행 클릭 시 상세 정보 다이얼로그 표시
- 입력일자(created_at), 수정일자(updated_at) 표시
- 수정 이력(modification_history) 테이블 표시

### 2.2 수정 기능
- 상세 다이얼로그에서 "수정" 버튼 클릭 시 편집 모드 전환
- 각 필드가 입력 필드로 변환됨
- "저장" 버튼으로 변경사항 저장
- "취소" 버튼으로 편집 모드 종료

### 2.3 수정 이력 자동 기록
- 변경된 필드만 이력에 기록
- 이전 값과 새 값 저장
- 수정 일시 자동 기록

---

## 3. 수정된 파일

### 3.1 프론트엔드

#### `src/pages/AuctionList.tsx`
- 수정 모드 상태 추가 (`isEditMode`, `editSaving`, `editForm`)
- `startEditMode()`: 편집 모드 시작, 폼 초기화
- `cancelEditMode()`: 편집 모드 취소
- `saveEdit()`: 변경사항 저장 및 이력 갱신
- 다이얼로그 헤더에 수정/저장/취소 버튼 추가
- 기본 정보 섹션에 조건부 입력 필드 렌더링

```typescript
// 수정 모드 상태
const [isEditMode, setIsEditMode] = useState(false)
const [editSaving, setEditSaving] = useState(false)
const [editForm, setEditForm] = useState<{...}>({})
```

#### `src/lib/api.ts`
- `updateAuction()`, `updatePrivateSale()`, `updateExpense()` 함수
- `getAuctionHistory()`, `getPrivateSaleHistory()`, `getExpenseHistory()` 함수
- `AuctionUpdate`, `PrivateSaleUpdate`, `ExpenseUpdate` 타입
- `ModificationHistory` 인터페이스

### 3.2 백엔드

#### `backend/main.py`
- `PUT /api/auctions/{auction_id}`: 위판 수정 API
- `PUT /api/private-sales/{sale_id}`: 사매 수정 API
- `PUT /api/expenses/{expense_id}`: 경비 수정 API
- `GET /api/auctions/{auction_id}/history`: 위판 이력 조회
- `GET /api/private-sales/{sale_id}/history`: 사매 이력 조회
- `GET /api/expenses/{expense_id}/history`: 경비 이력 조회

```python
@app.put("/api/auctions/{auction_id}")
def update_auction(auction_id: str, auction: AuctionUpdate):
    # 기존 데이터 조회
    # 변경된 필드 확인 및 이력 기록
    # 데이터 업데이트
    # 커밋
```

#### `backend/database.py`
- `modification_history` 테이블 생성
- `auctions`, `private_sales`, `expenses` 테이블에 `updated_at` 컬럼 추가

```sql
CREATE TABLE IF NOT EXISTS modification_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    record_type TEXT NOT NULL,
    record_id TEXT NOT NULL,
    field_name TEXT NOT NULL,
    old_value TEXT,
    new_value TEXT,
    modified_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

---

## 4. 해결된 이슈

### 4.1 수정 이력이 저장되지 않는 문제
**원인**: `conn.commit()`이 `if update_fields:` 블록 안에만 있어서 이력 INSERT가 커밋되지 않음

**해결**:
```python
# 변경 전
if update_fields:
    cursor.execute(...)
    conn.commit()

# 변경 후
history_recorded = False
for field, new_val in field_map.items():
    if new_val is not None and old_val != new_val_str:
        cursor.execute(INSERT INTO modification_history...)
        history_recorded = True

if update_fields:
    cursor.execute(UPDATE...)

if update_fields or history_recorded:
    conn.commit()
```

### 4.2 SQLite ALTER TABLE 오류
**원인**: SQLite는 `ALTER TABLE ... ADD COLUMN ... DEFAULT CURRENT_TIMESTAMP` 지원 안함

**해결**: 기본값 없이 컬럼 추가
```python
# 변경 전
cursor.execute("ALTER TABLE auctions ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP")

# 변경 후
cursor.execute("ALTER TABLE auctions ADD COLUMN updated_at TIMESTAMP")
```

### 4.3 React 상태 비동기 문제
**원인**: 상태 업데이트 후 바로 사용 시 이전 값 참조

**해결**: 함수 시작 시 필요한 값을 변수에 저장
```typescript
const saveEdit = async () => {
    const recordId = selectedRecord.id  // 미리 저장
    const recordType = selectedRecordType
    // ...
    historyRes = await getAuctionHistory(recordId)  // 저장된 값 사용
}
```

---

## 5. 데이터베이스 스키마

### modification_history 테이블
| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| id | INTEGER | PK, 자동증가 |
| record_type | TEXT | 'auction', 'private_sale', 'expense' |
| record_id | TEXT | 원본 레코드 ID |
| field_name | TEXT | 변경된 필드명 |
| old_value | TEXT | 이전 값 |
| new_value | TEXT | 새 값 |
| modified_at | TIMESTAMP | 수정 일시 |

---

## 6. API 명세

### 위판 수정
```
PUT /api/auctions/{auction_id}
Body: {
    auction_date?: string,
    auction_port?: string,
    fish_species?: string,
    quantity?: number,
    unit_price?: number,
    buyer?: string,
    note?: string
}
Response: { message: string, data: AuctionData }
```

### 위판 이력 조회
```
GET /api/auctions/{auction_id}/history
Response: { data: ModificationHistory[] }
```

---

## 7. 커밋 이력

| 해시 | 메시지 |
|------|--------|
| 78e5b18 | feat: 위판/사매/경비 상세 정보 수정 기능 추가 |
| 0ea3806 | feat: 위판 실적 조회 상세 보기 및 수정이력 기능 추가 |
| c557f55 | fix: 위판 실적 조회에 비고 컬럼 추가 |

---

## 8. 사용 방법

1. 위판 실적 조회 페이지 접속
2. 테이블에서 원하는 행 클릭
3. 상세 다이얼로그에서 "수정" 버튼 클릭
4. 필드 값 수정
5. "저장" 버튼 클릭
6. 하단의 "수정 이력" 섹션에서 변경 내역 확인
